using MalwarebytesOneviewApi.Core;
using MalwarebytesOneviewApi.Models;
using Play.Application.Malwarebytes.Interfaces;

namespace Play.Application.Malwarebytes.Services;

public class MalwarebytesDetectionService : IMalwarebytesDetectionService
{
    private readonly MbamOneViewApi _mbam;

    public MalwarebytesDetectionService(MbamOneViewApi mbam)
    {
        _mbam = mbam;
    }

    /// <summary>
    ///     Get detections by account id
    /// </summary>
    /// <param name="accountId"></param>
    /// <returns></returns>
    public async Task<MbamOneViewDetection[]> GetDetectionsByAccountIdAsync(string accountId)
    {
        return await _mbam._DetectionCommands.GetDetectionsAsync(accountId);
    }

    /// <summary>
    ///     Get all detections
    /// </summary>
    /// <returns></returns>
    public async Task<MbamOneViewDetection[]> GetAllDetectionsAsync()
    {
        var sites = await _mbam._SiteCommands.GetSites();
        var detections = new List<MbamOneViewDetection>();

        foreach (var t in sites)
        {
            var siteDetections = await _mbam._DetectionCommands.GetDetectionsAsync(t.AccountId.ToString());
            detections.AddRange(siteDetections);
        }

        return detections.ToArray();
    }
}